workflow:
  rules:
    # ìµœì´ˆ ì»¤ë°‹/ìƒˆë¡œìš´ ë¸Œëœì¹˜ ë¶„ê¸°ì¸ ê²½ìš° ì „ì²´ íŒŒì´í”„ë¼ì¸ ìŠ¤í‚µ
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME =~ /^develop-(fe|be)$/ && $CI_COMMIT_BEFORE_SHA == "0000000000000000000000000000000000000000"'
      when: never
    # ê·¸ ì™¸ì˜ ê²½ìš° íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
    - when: always

stages:
  - guard
  - build

# ê°€ë“œ ìŠ¤í…Œì´ì§€ - í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ ë¸Œëœì¹˜ ê°„ ìƒí˜¸ ì˜í–¥ ë°©ì§€
frontend-guard:
  stage: guard
  image:
    name: alpine/git:latest
    entrypoint: [""]
  script: |
    set -e
    echo "Running frontend guard..."

    if [ "$CI_PIPELINE_SOURCE" = "push" ]; then
      if git merge-base --is-ancestor "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA"; then
        DIFF_RANGE="$CI_COMMIT_BEFORE_SHA..$CI_COMMIT_SHA"
      else
        BASE=$(git merge-base "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
        DIFF_RANGE="$BASE..$CI_COMMIT_SHA"
      fi
    else
      TARGET="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-develop-fe}"
      BASE="${CI_MERGE_REQUEST_DIFF_BASE_SHA:-origin/$TARGET}"
      git fetch --no-tags --depth=1 origin "$TARGET" || true
      DIFF_RANGE="$BASE..$CI_COMMIT_SHA"
    fi

    echo "Diff range: $DIFF_RANGE"
    CHANGED="$(git diff --name-only $DIFF_RANGE || true)"
    echo ""

    if echo "$CHANGED" | grep -q '^backend/'; then
      echo "ğŸ”´ í”„ë¡ íŠ¸ì—”ë“œ ë¸Œëœì¹˜ì—ì„œ ë°±ì—”ë“œ íŒŒì¼ ë³€ê²½ ê°ì§€"
      echo "$CHANGED" | grep '^backend/' || true
      exit 1
    fi

    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ê°€ë“œ í†µê³¼"
  rules:
    # develop-fe ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•œ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "develop-fe"'

    # MR ëŒ€ìƒ ë¸Œëœì¹˜ê°€ develop-feì¸ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop-fe"'
    
    # ê¸°íƒ€ ì¼€ì´ìŠ¤ - íŒŒì´í”„ë¼ì¸ ìŠ¤í‚µ
    - when: never

backend-guard:
  stage: guard
  image:
    name: alpine/git:latest
    entrypoint: [""]
  script: |
    set -e
    echo "Running backend guard..."

    if [ "$CI_PIPELINE_SOURCE" = "push" ]; then
      if git merge-base --is-ancestor "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA"; then
        DIFF_RANGE="$CI_COMMIT_BEFORE_SHA..$CI_COMMIT_SHA"
      else
        BASE=$(git merge-base "$CI_COMMIT_BEFORE_SHA" "$CI_COMMIT_SHA")
        DIFF_RANGE="$BASE..$CI_COMMIT_SHA"
      fi
    else
      TARGET="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-develop-be}"
      BASE="${CI_MERGE_REQUEST_DIFF_BASE_SHA:-origin/$TARGET}"
      git fetch --no-tags --depth=1 origin "$TARGET" || true
      DIFF_RANGE="$BASE..$CI_COMMIT_SHA"
    fi

    echo "Diff range: $DIFF_RANGE"
    CHANGED=$(git diff --name-only $DIFF_RANGE || true)
    echo ""

    if echo "$CHANGED" | grep -q '^frontend/'; then
      echo "ğŸ”´ ë°±ì—”ë“œ ë¸Œëœì¹˜ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë³€ê²½ ê°ì§€"
      echo "$CHANGED" | grep '^frontend/' || true
      exit 1
    fi
    echo "âœ… ë°±ì—”ë“œ ê°€ë“œ í†µê³¼"
  rules:
    # develop-be ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•œ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "develop-be"'

    # MR ëŒ€ìƒ ë¸Œëœì¹˜ê°€ develop-beì¸ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop-be"'
    
    # ê¸°íƒ€ ì¼€ì´ìŠ¤ - íŒŒì´í”„ë¼ì¸ ìŠ¤í‚µ
    - when: never


# ê°€ë“œ ì„±ê³µì‹œ ë°±ì—”ë“œ CI íŠ¸ë¦¬ê±°
trigger-backend:
  stage: build
  trigger:
    include:
      - local: backend/.gitlab-ci.yml
    strategy: depend
  rules:
    # develop-be ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•˜ê³  ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "develop-be"'
      changes: [ "backend/**/*" ]

    # MRëŒ€ìƒ ë¸Œëœì¹˜ê°€ develop-beì´ê³ , ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop-be"'
      changes: [ "backend/**/*" ]

# ê°€ë“œ ì„±ê³µì‹œ í”„ë¡ íŠ¸ì—”ë“œ CI íŠ¸ë¦¬ê±°
trigger-frontend:
  stage: build
  trigger:
    include:
      - local: frontend/.gitlab-ci.yml
    strategy: depend
  rules:
    # develop-fe ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•œ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "develop-fe"'
      changes: [ "frontend/**/*" ]

    # MRëŒ€ìƒ ë¸Œëœì¹˜ê°€ develop-feì´ê³ , ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop-fe"'
      changes: [ "frontend/**/*" ]


# ë§ˆìŠ¤í„° ë¸Œëœì¹˜ì—ì„œ ë°±ì—”ë“œ CI íŠ¸ë¦¬ê±°
trigger-backend-master:
  stage: build
  trigger:
    include:
      - local: backend/.gitlab-ci.yml
    strategy: depend
  rules:
    # master ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•œ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "master"'
      changes: [ "backend/**/*" ]

    # MRëŒ€ìƒ ë¸Œëœì¹˜ê°€ masterì´ê³ , ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
      changes: [ "backend/**/*" ]

# ë§ˆìŠ¤í„° ë¸Œëœì¹˜ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ CI íŠ¸ë¦¬ê±°
trigger-frontend-master:
  stage: build
  trigger:
    include:
      - local: frontend/.gitlab-ci.yml
    strategy: depend
  rules:
    # master ë¸Œëœì¹˜ì— ì¼ë°˜ í‘¸ì‹œê°€ ë°œìƒí•œ ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "master"'
      changes: [ "frontend/**/*" ]

    # MRëŒ€ìƒ ë¸Œëœì¹˜ê°€ masterì´ê³ , ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
      changes: [ "frontend/**/*" ]