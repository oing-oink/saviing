image: oven/bun:1

variables:
  BUN_INSTALL_CACHE_DIR: '$CI_PROJECT_DIR/.bun_cache'

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "parent_pipeline"'
      when: always
    - when: never

stages:
  - start
  - setup
  - test_and_build

default:
  cache:
    key:
      files:
        - frontend/bun.lock
    paths:
      - .bun_cache/
    policy: pull-push
  before_script:
    - cd frontend
    - rm -f package-lock.json
    - rm -rf node_modules bun.lock ../.bun_cache .bun_cache
    - bun install --no-save

start:
  stage: start
  before_script: []
  script:
    - echo "프론트엔드 파이프라인 시작"

setup_environment:
  stage: setup
  before_script: []
  script:
    - mkdir -p frontend
    - |
      cat > frontend/.env << EOF
      # .env generated by CI
      VITE_API_BASE_URL=${VITE_API_BASE_URL}
      EOF
  artifacts:
    paths:
      - frontend/.env
    expire_in: 1h

lint_check:
  stage: test_and_build
  needs: ['setup_environment']
  dependencies:
    - setup_environment
  script:
    - bun run lint

format_check:
  stage: test_and_build
  needs: ['setup_environment']
  dependencies:
    - setup_environment
  script:
    - bun run format:check

build_project:
  stage: test_and_build
  needs: ['setup_environment']
  dependencies:
    - setup_environment
  script:
    - bun run build
